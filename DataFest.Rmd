---
title: "DataFest"
author: "Albert Sun and Ben Wallace"
date: "4/9/2020"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r upload packages, results = "hide"}
library(dplyr)
library(ggplot2)
library(patchwork)
library(twitteR)
library(lubridate)
library(rvest)
library(sf)
library(tidycensus)
library(mapview)
library(broom)
library(tidyverse)       # Tidyverse for Tidy Data
library(readxl)
library(tigris)
library(sf)
library(viridis)
library(stringr)
library(maps)
```

```{r read files, results = "hide"}
counties <- read.csv("datafiles/us-counties.csv")
states <- read.csv("datafiles/us-states.csv")
measures <- read.csv("datafiles/statedata.csv")
global_measures <- read.csv("datafiles/ACAPSGlobalResponse.csv")
covidapproval <- read.csv("datafiles/Covidapproval_Population.csv")
jails <- read.csv("datafiles/Jails.finalstates.csv")
lajails <- read.csv("datafiles/la_incarceration.csv")
```

```{r topten}
toptencounties <- counties %>%
  filter(date == "2020-04-08") %>%
  arrange(desc(cases))
  
toptencounties <- toptencounties[1:10,]

toptenstates <- states %>%
  filter(date == "2020-04-08") %>%
  arrange(desc(cases))

toptenstates <- toptenstates[1:10,]
```

# NY State and County Date

```{r plot}
p1 <- ggplot(data = toptencounties, mapping = aes(x = reorder(county, cases), 
                                                  y = cases), 
             fill=if_else(County=="New York")) +
  geom_bar(stat = "identity") + 
  labs(title = "Top 10 Coronavirus counties cases", 
       y = "Cases", x = "County Name") + 
  coord_flip()

p2 <- ggplot(data = toptenstates, mapping = aes(x = reorder(state, cases), 
                                                y = cases)) +
  geom_bar(stat = "identity") + 
  labs(title = "Top 10 Coronavirus states cases", 
       y = "Cases", x = "State Name") + 
  coord_flip() 

p1 + p2
```

# Global Measures

```{r countries_most_social_distancing}
global_measures %>%
  filter(CATEGORY == "Social distancing") %>%
  count(COUNTRY) %>%
  arrange(-n)
```

First Social Distancing Measure From top-10 quickest and top-10 slowest Country 
to test responsiveness:

```{r convert_dates_to_ordered_lubridate}
first_measures <- global_measures %>%
  filter(CATEGORY == "Social distancing") %>%
  mutate(date = dmy(DATE_IMPLEMENTED)) %>%
  arrange(COUNTRY, date) %>%
  select(COUNTRY, date) %>%
  group_by(COUNTRY) %>%
  slice(1) %>%
  ungroup() %>%
  select(COUNTRY, date) %>%
  arrange(date) %>%
  slice(-11:-n()-10)
```

```{r top_bottom_10_reactions}
ggplot(first_measures, mapping = aes(x = reorder(COUNTRY, date), y = date)) +
  geom_point() + coord_flip() + 
  labs(y = "1st Social Distancing Measure Date", x = "Country",
       title = "1st Social Distancing Implemented") + 
  theme_minimal(base_size = 14)
```

# Jail Data

```{r Overview of Data}
jails %>%
  summarise(n(), n_distinct(State_Abbrev)) 
```

We have data from 334 counties from 27 states.

```{r Race}
# P005003 = White 
# P005004 = Black
# P005004 = Hispanic
# P005005 = AmInd/AK
# P005006 = Asian
# P001001 = Population Total

black <- c("P005004")

blackgeo <- get_decennial(geography = "county", variables = black, year = 2010, summary_var = "P001001", geometry = TRUE) %>%
  mutate(pctblack = 100 * (value / summary_value))

jails$CountyState = as.character(jails$CountyState)
blackgeo$NAME = str_replace(blackgeo$NAME, " County", "")
blackgeo$NAME = str_replace(blackgeo$NAME, " Parish", "")

jails <- left_join(jails, blackgeo, by = c("CountyState" = "NAME"))

stategeo <- st_as_sf(map("state", plot = FALSE, fill = TRUE))
                        
jails <- jails %>%
  drop_na()

jails$geom = jails$geometry

ggplot() +
  geom_sf(aes(geometry = geom, fill = pctblack, color = pctblack), data = jails) +
  labs(title = "Percent Black by County",
       fill = "Percent Black",
       color = "Percent Black") + 
  scale_fill_viridis(option = "viridis") + 
  scale_color_viridis(option = "viridis") +
  geom_sf(data = stategeo, fill = NA) +
  theme(panel.background = element_rect(fill = "white")) 

```

```{r}
### Mapping Jurisdictions

jails$Jurisdiction_Profile = recode_factor(jails$Jurisdiction_Profile, "R" = "Conservative", "M" = "Moderate", "B" = "Liberal")

ggplot(data = jails, aes(x = Jurisdiction_Profile)) +
  geom_bar(aes(fill = Jurisdiction_Profile), color = "black") +
  scale_fill_manual(values = c("DarkRed", "ForestGreen", "Blue4")) +
  labs(x = "Judicial Profile",
       y = "Frequency",
       title = "Judicial Profile") +
  theme(legend.position = "none") +
  theme(panel.background = element_rect(fill = "white"))

ggplot() +
  geom_sf(aes(geometry = geom, fill = Jurisdiction_Profile), data = jails) +
  labs(title = "Jurisdiction Profile",
       fill = "Jurisdiction Profile") + 
  geom_sf(data = stategeo, fill = NA) +
  scale_fill_manual(values = c("darkred", "forestgreen", "blue2")) +
  theme(panel.background = element_rect(fill = "white")) 

  
```

```{r top-ten-drops}
theme_set(theme_bw())

topTenJails <- jails %>%
  filter(State == "Louisiana") %>%
  arrange(Percent_Change) %>%
  mutate(percent_needed = Target_Jail_Population / Jail_Population_Latest * 100) %>%
  select(County, percent_needed, PreCovid_Jail_Pop) %>%
  slice(1:10) 
topTenJails

Int_Plot <- ggplot(topTenJails, aes(x = reorder(County, PreCovid_Jail_Pop), 
                                    y = percent_needed)) +
  geom_col() + 
  coord_flip() + 
  labs(x = "Jails w/ Biggest Pop. Reduction", y = "Percent (%) Decrease Still Needed
to Match International Norms",
  title = "Over-Incarceration Still Exists in Louisiana 
After Jails Release People Early for COVID-19") + 
  theme_classic(base_size = 16)

Int_Plot

```

# Slope


```{r slope-chart}
#top ten jail decreases with initial jail population >50
topTenJails <- jails %>%
  arrange(Percent_Change) %>%
  filter(State == "Louisiana") %>%
  filter(PreCovid_Jail_Pop > 50) %>%
  select(CountyState, County, Percent_Change, PreCovid_Jail_Pop, Jail_Population_Latest) %>%
  slice(1:10) %>%
  arrange(-PreCovid_Jail_Pop) %>%
  mutate(class = ifelse(Jail_Population_Latest-PreCovid_Jail_Pop >= 0, "red", "green"))
         
topTenJails

left_label <- c(paste(topTenJails$County, topTenJails$PreCovid_Jail_Pop, sep=", ")[1:3],character(7))
right_label <- c(paste(topTenJails$County, topTenJails$Jail_Population_Latest,sep=", ")[1:3],character(7))

library(scales)
theme_set(theme_classic())
p <- ggplot(topTenJails) + 
  geom_segment(aes(x=1, xend=2, y=PreCovid_Jail_Pop, yend=Jail_Population_Latest, col=class), size=.75, show.legend=F) + 
  geom_vline(xintercept=1, linetype="dashed", size=.1) + 
  geom_vline(xintercept=2, linetype="dashed", size=.1) +
  scale_color_manual(labels = c("Up", "Down"), 
                     values = c("green"="#00ba38", "red" = "#f8766d")) +  # color of lines
  xlim(0.5,2.5) +
  ylim(0,1100) + 
  labs(x="", 
       y="# People in Jail", 
       title = "Slope Chart: Top Ten Jail 
Population Decreases in Louisiana",
       caption = "Counties Not Labelled: Washington, Jackson, 
Concordia, Vernon, Allen, De Soto, Catahoula") + 
  theme_classic(base_size = 16)

p <- p + geom_text(label=left_label, y=topTenJails$PreCovid_Jail_Pop+10, x=rep(1, NROW(topTenJails)), hjust=1.1, size=3.5)
p <- p + geom_text(label=right_label, y=topTenJails$Jail_Population_Latest, x=rep(2, NROW(topTenJails)), hjust=-0.1, size=3.5)


p <- p + geom_text(label="Before
           COVID-19", x=1, y=1.12*(max(topTenJails$PreCovid_Jail_Pop, topTenJails$Jail_Population_Latest)), hjust=1, size=5.5)  # title
p <- p + geom_text(label="4/9/2020", x=2, y=1.12*(max(topTenJails$PreCovid_Jail_Pop, topTenJails$Jail_Population_Latest)), hjust=-0.1, size=5.5)  # title


p <- p + theme(panel.background = element_blank(), 
           panel.grid = element_blank(),
           axis.ticks = element_blank(),
           axis.text.x = element_blank(),
           panel.border = element_blank(),
           plot.margin = unit(c(1,2,1,2), "cm"))

p
```


  
```{r Summarise Plot}
sum_jail <- jails %>%
  summarise(sum(PreCovid_Jail_Pop), sum(Jail_Population_Latest))
sum_jail
# how to plot using ggplot?
```

```{r bunch_of_graphs}
ggplot(data = jails, aes(x = Percent_Change)) +
  geom_histogram()

ggplot(data = jails, aes(x = County_Profile)) +
  geom_histogram(binwidth = .025)

ggplot(data = jails, aes(x = State_Profile)) +
geom_histogram(binwidth = 5)

ggplot(data = jails, aes(x = Jurisdiction_Profile)) +
  geom_bar()

ggplot(data = jails, aes(x = Incarceration_Per_100K)) +
geom_histogram()

ggplot(data = jails, aes(x = COVID.19_Cases)) +
  geom_histogram()

jails %>%
  summarise(mean = mean(COVID.19_Cases), ## Also log transform this?
            median = median(COVID.19_Cases)
  )

ggplot(data = jails, aes(x = log(Deaths_Per_100K_Residents))) + ### Log transform variable?
  geom_histogram()

```

```{r Step-wise Strategy for Model Fitting}
lm_full <- lm(Percent_Change ~ County_Profile + State_Profile +
                Jurisdiction_Profile, data = jails)

lm <- step(lm_full, direction = "backward", trace=FALSE) 

tidy(lm) %>%
  select(term, estimate, p.value)
```
#^Stepwise function uses similar strategy to adjusted R squared to find the best
#fit model with constrinas in mind. Here, it finds that Jurisdiction_Profile is 
#the most important relationship
```{r graph Jurisdiction_Profile vs. Percent_Change:}
ggplot(data = jails, aes(x = Jurisdiction_Profile, y = Percent_Change)) + 
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE) + 
  theme_minimal()
```

This graph doesn't look very legit...

```{r diagnostic_plots}
plot_diagnostic <- function(x, data) {
  
  plot_residuals <- augment(x) %>%
    ggplot(aes(x = .fitted, y = .resid)) +
    geom_point() + 
    geom_hline(yintercept = 0, color = "blue", lty = 2) +
    labs(x = expression(hat(y)), y = "Residual Value", 
         title = "Residuals Plot") 
  
  plot_normality <- augment(x) %>%
    ggplot(aes(x = .resid)) +
    geom_histogram(binwidth = .01, alpha = .5, color = "orange") + 
    labs(x = "Residual Value", y = "Count", title = "Normality Plot") 
  
  plot_independence <- augment(x) %>%
    ggplot(aes(x = 1:nrow(data), y = .resid)) + 
    geom_point() + 
    labs(x = "Index", y = "Residual Value", title = "Independence Plot") 
  
  plot_residuals / (plot_normality + plot_independence)
}

plot_diagnostic(lm, jails)
```
Conditions of Linearity:

Condition 1: We must verify that observations are independent. In this case, 
there doesnâ€™t seem to be a pattern in the residual scatter plot, so the 
observations are independent.

Conditions 2 & 4: We must verify that the distribution of residuals is around 0 
and has constant variance. The variance plot shows that the distribution of 
residuals is centered around 0 and has constant variance throughout.

Condition 3: We must verify the normality of residuals. The residual histogram 
displays a normal distribution of residual values, so we have verified the 
normality of residuals.

```{r Lets try County_Profile now}
model <- lm(Percent_Change ~ County_Profile + State_Profile + Jurisdiction_Profile + Cases_Per_100K_Residents + COVID.19_Deaths, data = jails)

tidy(model)

ggplot(data = jails, aes(x = County_Profile, y = log(abs(Percent_Change)))) + 
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE) + 
  theme_minimal()
```
Doesn't seem very legit either...

```{r augmentmodel}
model_aug <- augment(model) %>%
  mutate(obs_num = row_number())
```

```{r leverage}
leverage_threshold <- 2*(5 + 1)/nrow(model_aug)

high_leverage <- model_aug %>%
  mutate(high_lev = .hat > leverage_threshold) %>%
  select(high_lev, obs_num)
```

```{r std.residuals}
ggplot(data = model_aug, aes(x = obs_num, y = .std.resid)) +
  geom_point()

model_aug %>%
  summarise(min = min(.std.resid),
            max = max(.std.resid),
            mean = mean(.std.resid),
            median = median(.std.resid))

high_sdresid <- model_aug %>%
  mutate(high_sd = abs(.std.resid) > 2) %>%
  select(obs_num, high_sd)
```

```{r cooksdistance}
ggplot(data = model_aug, aes(x = obs_num, y = .cooksd)) + 
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 1, color = "red")

high_cookdist <- model_aug %>%
  mutate(high_cook = .cooksd > 1) %>%
  select(obs_num, high_cook)
```

```{r unusual observations}
unusual <- bind_cols(high_leverage, high_sdresid, high_cookdist)

unusual <- unusual %>%
  select(high_lev, high_sd, high_cook)
```

Obs 245 has a high cook distance and is a leverage point, so we should consider removing it from the model. 

Also look into the cases with high std. residuals to see if they should be removed.

```{r}
jails <- jails %>%
  mutate(obs_num =  1:n()) %>%
  filter(obs_num != 245)
```

```{r}
model2 <- lm(Percent_Change ~ County_Profile + State_Profile + Jurisdiction_Profile + COVID.19_Cases + pctblack + pctblack*Jurisdiction_Profile, data = jails)

tidy(model2)

model2_aug <- augment(model2)

model2_aug <- model2_aug%>%
  mutate(obs_num = c(1:n()))

step_model2 <- step(model2, direction = "backward", trace=FALSE) 

step_model2

```

step wise regression (*step function)

```{r}
summary(step_model2)
```

```{r}
ggplot(data = model2_aug, aes(x = obs_num, y = .resid)) +
  geom_point()
```

```{r}

```

